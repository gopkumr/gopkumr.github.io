<!doctype html><html lang=en-au><head><meta charset=utf-8><meta name=viewport content="width=device-width"><script type=application/javascript src=https://www.beneathabstraction.com/js/theme-mode.js></script><link rel=stylesheet href=https://www.beneathabstraction.com/css/frameworks.min.css><link rel=stylesheet href=https://www.beneathabstraction.com/css/github.min.css><link rel=stylesheet href=https://www.beneathabstraction.com/css/github-style.css><link rel=stylesheet href=https://www.beneathabstraction.com/css/light.css><link rel=stylesheet href=https://www.beneathabstraction.com/css/dark.css><link rel=stylesheet href=https://www.beneathabstraction.com/css/syntax.css><title>Implementing Feature flags in azure - Beneath Abstraction</title><link rel=icon type=image/x-icon href=/images/github.png><meta name=theme-color content="#1e2327"><meta name=description content="Feature flag is a very popular practice in modern application development, which is used to specifically hide features implemented that are not yet ready to be used by wider audience, and when ready can be enabled by a flip of a switch. The flags can also be used as a kill switch for application feature when it not working as expected.
With feature flags implemented, it would be effective to have the features enabled or disabled from a location outside of the application infrastructure or configuration, this way we can have features spanning across applications be controlled via a centralized flag."><meta name=keywords content="blog,techical blog,Microsoft .Net,Csharp,asp.net,docker,mvc,kubernetes,pulumi"><meta name=robots content="noodp"><link rel=canonical href=https://www.beneathabstraction.com/post/azurefeatureflags/><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementing Feature flags in azure  - Beneath Abstraction"><meta name=twitter:description content="Feature flag is a very popular practice in modern application development, which is used to specifically hide features implemented that are not yet ready to be used by wider audience, and when ready can be enabled by a flip of a switch. The flags can also be used as a kill switch for application feature when it not working as expected.
With feature flags implemented, it would be effective to have the features enabled or disabled from a location outside of the application infrastructure or configuration, this way we can have features spanning across applications be controlled via a centralized flag."><meta name=twitter:site content="https://www.beneathabstraction.com/"><meta name=twitter:creator content><meta name=twitter:image content="https://www.beneathabstraction.com/"><meta property="og:type" content="article"><meta property="og:title" content="Implementing Feature flags in azure  - Beneath Abstraction"><meta property="og:description" content="Feature flag is a very popular practice in modern application development, which is used to specifically hide features implemented that are not yet ready to be used by wider audience, and when ready can be enabled by a flip of a switch. The flags can also be used as a kill switch for application feature when it not working as expected.
With feature flags implemented, it would be effective to have the features enabled or disabled from a location outside of the application infrastructure or configuration, this way we can have features spanning across applications be controlled via a centralized flag."><meta property="og:url" content="https://www.beneathabstraction.com/post/azurefeatureflags/"><meta property="og:site_name" content="Implementing Feature flags in azure "><meta property="og:image" content="https://www.beneathabstraction.com/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-05-16 10:00:48 +1100 +1100"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-171421715-1"></script><script>if(navigator.doNotTrack!=='1'){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-171421715-1')}</script></head><body><div style=position:relative><header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"><div class="Header-item mobile-none" style=margin-top:-4px;margin-bottom:-4px><a class=Header-link href=https://www.beneathabstraction.com/><svg class="octicon" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class="Header-item d-md-none"><button class="Header-link btn-link js-details-target" type=button onclick="document.querySelector('#header-search').style.display=document.querySelector('#header-search').style.display=='none'?'block':'none'"><svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button></div><div style=display:none id=header-search class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"><div class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"><div class=position-relative><form target=_blank action=https://www.google.com/search accept-charset=utf-8 method=get autocomplete=off><label class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"><input type=text class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable" name=q placeholder=Search autocomplete=off>
<input type=hidden name=q value=site:https://www.beneathabstraction.com/></label></form></div></div></div><div class="Header-item Header-item--full flex-justify-center d-md-none position-relative"><a class=Header-link href=https://www.beneathabstraction.com/><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a></div><div class=Header-item style=margin-right:0><a href=javascript:void(0) class="Header-link no-select" onclick=switchTheme()><svg style="fill:var(--color-profile-color-modes-toggle-moon)" class="no-select" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.52208 7.71754c3.05612.0 5.53362-2.47748 5.53362-5.5336C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961 9.95801 1.07727 10.3495.771159 10.6474.99992c1.4679 1.12724 2.4141 2.90007 2.4141 4.89391.0 3.40575-2.7609 6.16667-6.16665 6.16667-2.94151.0-5.40199-2.0595-6.018122-4.81523C.794841 6.87902 1.23668 6.65289 1.55321 6.85451 2.41106 7.40095 3.4296 7.71754 4.52208 7.71754z"/></svg></a></div></header></div><div><main><div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4"><div class=px-0><div class="mb-3 d-flex px-3 px-md-3 px-lg-5"><div class="flex-auto min-width-0 width-fit mr-3"><div class=d-flex><div class="d-none d-md-block"><a class="avatar mr-2 flex-shrink-0" href=https://www.beneathabstraction.com/><img class=avatar-user src="https://avatars.githubusercontent.com/u/1662197?s=400&u=d1fd525c38f21c760b5f73d3046d9cdee3debcc3&v=4" width=32 height=32></a></div><div class="d-flex flex-column"><h1 class="break-word f3 text-normal mb-md-0 mb-1"><span class=author><a href=https://www.beneathabstraction.com/>Gopakumar</a></span><span class=path-divider>/</span><strong class="css-truncate-target mr-1" style=max-width:410px><a href=https://www.beneathabstraction.com/post/azurefeatureflags/>Implementing Feature flags in azure</a></strong></h1><div class="note m-0">Created <relative-time datetime="Sun, 16 May 2021 10:00:48 +1100" class=no-wrap>Sun, 16 May 2021 10:00:48 +1100</relative-time></div></div></div></div></div></div></div><div class="container-lg px-3 new-discussion-timeline"><div class="repository-content gist-content"><div><div class="js-gist-file-update-container js-task-list-container file-box"><div id=file-pytest class="file my-2"><div class="file-header d-flex flex-md-items-center flex-items-start"><div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">922 Words</div><div class="file-actions flex-order-2 pt-0"><a class="muted-link mr-3" href=/tags/developer><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>developer</a>
<a class="muted-link mr-3" href=/tags/.net><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>.Net</a>
<a class="muted-link mr-3" href=/tags/visual-studio><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>visual studio</a>
<a class="muted-link mr-3" href=/tags/feature-flags><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>feature flags</a>
<a class="muted-link mr-3" href=/tags/azure><svg class="octicon octicon-tag" viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M2.5 7.775V2.75a.25.25.0 01.25-.25h5.025a.25.25.0 01.177.073l6.25 6.25a.25.25.0 010 .354l-5.025 5.025a.25.25.0 01-.354.0l-6.25-6.25A.25.25.0 012.5 7.775zm-1.5.0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464.0.91.184 1.238.513l6.25 6.25a1.75 1.75.0 010 2.474l-5.026 5.026a1.75 1.75.0 01-2.474.0l-6.25-6.25A1.75 1.75.0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z"/></svg>azure</a></div></div></div><div class="Box-body px-5 pb-5"><article class="markdown-body entry-content container-lg"><p>Feature flag is a very popular practice in modern application development, which is used to specifically hide features implemented that are not yet ready to be used by wider audience, and when ready can be enabled by a flip of a switch. The flags can also be used as a kill switch for application feature when it not working as expected.</p><p>With feature flags implemented, it would be effective to have the features enabled or disabled from a location outside of the application infrastructure or configuration, this way we can have features spanning across applications be controlled via a centralized flag. Azure has feature management as part of the Azure App configuration service which can manage feature flags and maintain it separate from your hosting model and will act as a centralized repository for feature flags. Microsoft also provides libraries for different programing languages to consume Azure App Configuration service. More about it can be <a href=https://docs.microsoft.com/en-us/azure/azure-app-configuration/manage-feature-flags>found here</a></p><h2 id=creating-azure-app-configuration>Creating Azure App Configuration</h2><p>To start with, create the App Configuration service in Azure. For trying out the service, I will use the free tier.
<img src=/blogimages/appconfig/createappconfigazure.png alt="Create service"></p><p>Once the service is created, In the left panel, under operations section, we can navigate to the Feature Manager screen and create a flag. The flag creation is as simple as giving a name to it. The screen also gives an option to create the flag as a FeatureFilter, which is used when the flag is not just a boolean value and you want to control the flag based on other criteria like a subset of users or switching a flag on/off for a time frame. We will keep the details on FeatureFilter for another post.
<img src=/blogimages/appconfig/featueflagcreationazure.png alt="Create flag"></p><p>Once the flag is created, it can be toggled from the feature manager screen.
<img src=/blogimages/appconfig/featuremanagerazure.png alt="Modify flag"></p><p>Note the connection string to the Azure AppConfiguration service, which we will use in our app to connect.
<img src=/blogimages/appconfig/connectionstring.png alt="Connection string"></p><h2 id=consuming-azure-app-configuration-in-a-webapp>Consuming Azure App Configuration in a WebApp</h2><p>I am implementing a simple web application using ASP.Net Core MVC default app to consume the app configuration service. Adding a view and a controller for the new feature called Feature1. The feature for now will only have a single index page which displays the feature name. Add the feature link to the navigation menu too. While the Microsoft FeatureManagement libraries in aspnetcore can work with flags stored in application&rsquo;s local config files or a database, here I am trying to have it work with the azure app configuration service.</p><p>To consume azure app configuration service we need add the below nuget package</p><pre><code>Microsoft.Azure.AppConfiguration.AspNetCore
</code></pre><p>aspnetcore feature management requires the below nuget pacakge</p><pre><code>Microsoft.FeatureManagement.AspNetCore
</code></pre><p>Add the Azure App Configuration connection string to the <code>appsettings.json</code> connection strings section with a key, i will use <code>AppConfiguration</code> .<br>To add the App Configuration from azure into the application, update the program.cs file <code>CreateWebHostBuilder</code> configuration. Within the configurewebhostdefaults method, add code to configure custom configuration source using <code>ConfigureAppConfiguration</code> method.<br>Within the method, retrieve the azure app configuration connection string from the <code>appsettings.json</code> and add the azure app configuration as a configuration source using <code>AddAzureAppConfiguration</code> method, also enable Feature flags.
<img src=/blogimages/appconfig/programcs.png alt="Program.cs changes"></p><p>Add the feature management to the dependency container using <code>AddFeatureManagement</code> in the configureservices method in startup.cs.
<img src=/blogimages/appconfig/startupcs.png alt="Startup.cs changes"></p><p>Once the setup is done there are few ways the feature flags can be used in the application code.</p><h3 id=action-filter>Action filter</h3><p>An action filter <code>FeatureGate("&lt;feature name>")</code> can be used to prevent the action from getting triggered if the feature name passed to the filter is not enabled in the Azure App Configuration.</p><p><img src=/blogimages/appconfig/featuregate.png alt="Action Filter usage"></p><h3 id=feature-manager-service>Feature Manager Service</h3><p>If the requirement is to stop execution of a logic based on the feature flag, then a service of type <code>IFeatureManager</code> can be injected in the controller and methods like <code>IFeatureManager.IsEnabledAsync("&lt;feature name>")</code> can be used to check if the feature is enabled.</p><p><img src=/blogimages/appconfig/featureservice.png alt="Feature manager service usage"></p><h3 id=navigation-links>Navigation Links</h3><p>By adding tag helpers from <code>@addTagHelper *, Microsoft.FeatureManagement.AspNetCore</code> gives the tag <code>&lt;feature name="&lt;feature name>"></code> to be used around links or buttons or sections, so that the content of the feature tag is not rendered when the feature specified in the name attribute is not enabled.</p><p><img src=/blogimages/appconfig/featuretag.png alt="Html feature tag usage"></p><p>Doing the above will let you switch on/off the feature in azure and the application will respond to it by removing the link from navigation as well as responding with a HTTP 404 if user tried to access the link directly. With the above implementation,the app needs to be restarted if the flag changes needs to get reflected, as the azure config is loaded only once when the app is launched. To have the config refreshed when it is changed in azure, we need to register a refresh for the azure configuration. Below is how we will do it.</p><p>First, the change to the code
<img src=/blogimages/appconfig/refreshkey.png alt="Refresh key usage"></p><p>Here the application monitors the <code>RefreshKey</code> for any change every 5 seconds (as specified in the cache expiry timespan), when a change in <code>RefreshKey</code> is noted all azure configurations are refreshed from the service for all keys (specified by refresh all flag).
The refresh key is created as a key-value in the app configuration explorer in azure app configuration.
<img src=/blogimages/appconfig/createrefreshkey.png alt="Refresh key usage"></p><p>For the refresh to work, we need to add the AzureAppconfiguration middleware by making the below changes in startup.cs
<img src=/blogimages/appconfig/AddAzureAppConfig.png alt="Add configuration middleware">
<img src=/blogimages/appconfig/useazureappconfig.png alt="Refresh configuration middleware"></p><p>After this is implemented, you can update your feature flag and modify the feature key, which will cause the app to get the updated feature flags. Advantage of using a refresh key is that, one single key change can trigger refresh of all the feature flags configured. Alternatively, you can register refresh for individual keys which can be set to refresh only those keys that have been updated.</p></article></div></div></div></div></div></div></main></div><div class="footer container-xl width-full p-responsive"><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><a aria-label=Homepage title=GitHub class="footer-octicon d-none d-lg-block mr-lg-4" href=https://www.beneathabstraction.com/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24"><path fill-rule="evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95.0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12.0.0.67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15.0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38A8.013 8.013.0 0016 8c0-4.42-3.58-8-8-8z"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">Theme by <a href=https://github.com/MeiK2333/github-style>github-style</a></li></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div></body><script type=application/javascript src=https://www.beneathabstraction.com/js/github-style.js></script></html>