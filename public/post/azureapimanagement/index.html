<!DOCTYPE html>
<html lang="en-au">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='http://localhost:1313/js/theme-mode.js'></script>
    <link rel="stylesheet" href='http://localhost:1313/css/frameworks.min.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/github.min.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/github-style.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/light.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/dark.css' />
    <link rel="stylesheet" href='http://localhost:1313/css/syntax.css' />
    <title>Azure API Management - What is it all about? - Beneath Abstraction</title>
    
    <link rel="icon" type="image/x-icon" href='/images/logo.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="Introduction Every thing about APIM, creating, hosting api, policies and different kind, subscruotion keys, products to distribute, Dev portal and testing it, monitoring and improve performance, app insight and key matrics. Infrastructure and pricing tiers and multi instances. VNet configs and application gateway and cost effective deployment. Configuration in repository. CICD with ARM templates. Managed Identities to interact with backend APIs.
Creating API Management To have an initial setup we are going to create the below resoources Create Resource group Log analystics Application insights API M Postal&amp;gt; search API management and create APIM." />
<meta name="keywords"
  content='blog, techical blog, Microsoft .Net, Csharp, asp.net, docker, mvc, kubernetes, pulumi' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://localhost:1313/post/azureapimanagement/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Azure API Management - What is it all about? - Beneath Abstraction" />
<meta name="twitter:description"
  content="Introduction Every thing about APIM, creating, hosting api, policies and different kind, subscruotion keys, products to distribute, Dev portal and testing it, monitoring and improve performance, app insight and key matrics. Infrastructure and pricing tiers and multi instances. VNet configs and application gateway and cost effective deployment. Configuration in repository. CICD with ARM templates. Managed Identities to interact with backend APIs.
Creating API Management To have an initial setup we are going to create the below resoources Create Resource group Log analystics Application insights API M Postal&amp;gt; search API management and create APIM." />
<meta name="twitter:site" content="http://localhost:1313/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="http://localhost:1313/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Azure API Management - What is it all about? - Beneath Abstraction">
<meta property="og:description"
  content="Introduction Every thing about APIM, creating, hosting api, policies and different kind, subscruotion keys, products to distribute, Dev portal and testing it, monitoring and improve performance, app insight and key matrics. Infrastructure and pricing tiers and multi instances. VNet configs and application gateway and cost effective deployment. Configuration in repository. CICD with ARM templates. Managed Identities to interact with backend APIs.
Creating API Management To have an initial setup we are going to create the below resoources Create Resource group Log analystics Application insights API M Postal&amp;gt; search API management and create APIM." />
<meta property="og:url" content="http://localhost:1313/post/azureapimanagement/" />
<meta property="og:site_name" content="Azure API Management - What is it all about?" />
<meta property="og:image"
  content="http://localhost:1313/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2021-08-25 12:44:46 &#43;1000 AEST" />











</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="http://localhost:1313/">
        <img class="octicon" height="32" width="32" src="/images/logo.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <img height="24" class="octicon octicon-three-bars" width="24" src="/images/logo.png">
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:http://localhost:1313/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="http://localhost:1313/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/logo.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="http://localhost:1313/">
                  <img class=" avatar-user"
                    src="https://avatars.githubusercontent.com/u/1662197?s=400&amp;u=d1fd525c38f21c760b5f73d3046d9cdee3debcc3&amp;v=4"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="http://localhost:1313/">Gopakumar</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="http://localhost:1313/post/azureapimanagement/">Azure API Management - What is it all about?</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Wed, 25 Aug 2021 12:44:46 &#43;1000"
                    class="no-wrap">
                    Wed, 25 Aug 2021 12:44:46 &#43;1000</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1055 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/tag1">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      tag1
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/tag2">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      tag2
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h2 id="introduction">Introduction</h2>
<p>Every thing about APIM, creating, hosting api, policies and different kind, subscruotion keys, products to distribute, Dev portal and testing it, monitoring and improve performance, app insight and key matrics. Infrastructure and pricing tiers and multi instances. VNet configs and application gateway and cost effective deployment. Configuration in repository. CICD with ARM templates. Managed Identities to interact with backend APIs.</p>
<h2 id="creating-api-management">Creating API Management</h2>
<p>To have an initial setup we are going to create the below resoources
Create Resource group
Log analystics
Application insights
API M
Postal&gt; search API management and create APIM. Pricing tiers, we&rsquo;ll use dev tier for learning purpose. Add an application insights too to the API management, you will have to create it a separate resource.  We also need to create a log analytics workspace too.</p>
<p>It take 30-40mins to create and once created will have a sample API already for us to refer to. We shall create an own API using the Add API option in the API Management</p>
<p>As for the example we will create an API management for the Open Weather Map API to get current weather and a 16 day forecast for passed zipcode and country or city name</p>
<p>We will use a function app to contain all the logic to call the open weather apis. Lets create a function app with based on .Net core 3.1 runtime.
Lets enable the application insights to the same as we created to use with API management.</p>
<p>Create a function with HTTP trigger called CurrentWeather and the add code to call the open weather api data and return the data as it is. Also from teh integration tab of the function only enable the GET verb to make it clear to the consumers that the function is used to get data. <em>all the code references are available in the github repo</em></p>
<p>Now we head back to the API management and import a function app and choose the function that we created. Which will create entries for the function app. We can test the flow of the call using the Test tab in the API Management. Another way to test is to run from the developer portal. You can straight away publish the portal and visit the portal and see the Current weather api published. We can test the API in the API management provided we register and get a subscription key to call the API. This is one layer of security in the API where the users are denied access to the api unless they have registered and got a  subscription key.</p>
<p>You will be able to view all the subscptions keys from the Subsciprions blade in the API management screen. You can switch off the suscription key requirement for a particular api using the settings tab of the API in the API Management and uncheck the Subscription required check box.</p>
<p>Developer portal
Create a new product and call it Weathers and with subscription and choose the open weather api functions that we added. The products is how the APIs are grouped togerther to be displayed in the developer portal.</p>
<p>Products
Access control in developer portal.  using Product  access control to give access to different groups and also set if the product required subscription or not.</p>
<p>Creating products is a way to group the APIs to add control on all those apis by managing the it at a single product level, features like access control, subscription , approval flows for subscripts etc.</p>
<p>Policies
API policies like a rate limit, authentication, request/response trasformation etc can be implemented at a product level which will affect all the APIs or at an API level for indovidual APIs.</p>
<p>Scope of a policy, at a global level, product level, API level and operation level.</p>
<p>Mock for Apis policy
While the backend API is not yet available, an API management can mock an API. To do that in the API, we can define a response with a sample response header and body and then add a policy called  mock-response.</p>
<p>Throttling
How many calls an API can take in a duration of time limit can be added using the rate-limit-by-key policy. In the policy we can define the number of calls and the time frame the limit should be imposed.</p>
<p>authentication policy
There are different way of authentication like basic authentication, authentication by client certificate.</p>
<p>check header
policy to validate the header values being passed</p>
<p>ip filter
Used to allow or deny any called from an IP or a range of IP to the API management end point</p>
<p>set quote usage
We can limit the API usage by number of calls or by bandwidth for a subscription by using this policy</p>
<p><a href="https://docs.microsoft.com/en-us/azure/api-management/api-management-policies">https://docs.microsoft.com/en-us/azure/api-management/api-management-policies</a></p>
<p>revision
Used to handle upgrades without impacting current subscribers. Add a new revision using the revisions tab. Once you add a revision, you can choose it in the revisions tab,  all the changes that we make in APIM will impact only the new revisions and not the old revisions. Once you make the new revision as current, all the consumers will be moved to the new revision. But if any consumers want the old revision, they can still call it by passing rev=<!-- raw HTML omitted --> in query string, until the revision is taken offline.</p>
<p>version
Version is different from revision. You can only have one revision online at a time, but you can have mulitple version online with multiple cusumers using differetn versions. You can click on the API and add a new version and the changes make will only reflected in the new version added. While creating a version we can choose if we want to have version being passed as a header value or as a query string and this is used to identify which version if the API is being requested. The new version created will not be part of the product and it might need to added explictly.</p>
<p>Managed Identites
To authenticate with azure functions we will use managed identities and use function keys to authorization. You can assign a system generated managed identities.
And in the azure function, in the authetication/authorization blade, enable app service authentiation and enable login with azure active diretory. And create an app for the azure function.
And also add a managed identity authentication to the inbound policy and give the function app url in the resource attribute</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='http://localhost:1313/js/toc.js'></script>
<link rel="stylesheet" href='http://localhost:1313/css/toc.css' />



  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="http://localhost:1313/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="http://localhost:1313/js/github-style.js"></script>





</html>